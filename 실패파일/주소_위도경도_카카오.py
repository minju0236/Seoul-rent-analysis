# -*- coding: utf-8 -*-
"""ë°ì´í„°->ìœ„ë„ê²½ë„ ë³€í™˜.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xcWIRa3zZnkEt9HT4CtNRgRrm8uW_b2N
"""

import pandas as pd
import requests
from tqdm import tqdm
import re

# âœ… ë„ˆì˜ API í‚¤ (ë³´ì•ˆ ì¤‘ìš”!)
API_KEY = "devU01TX0FVVEgyMDI1MDYwNTIwMjA1NDExNTgyMTY="

# ğŸ“ ì£¼ì†Œ â†’ ìœ„ë„/ê²½ë„ ë³€í™˜ í•¨ìˆ˜
def get_coords_juso(address):
    url = "https://business.juso.go.kr/addrlink/addrLinkApi.do"
    params = {
        "confmKey": API_KEY,
        "currentPage": 1,
        "countPerPage": 1,
        "keyword": address,
        "resultType": "json"
    }

    try:
        response = requests.get(url, params=params, timeout=3)
        result = response.json()
        juso = result['results']['juso']
        if juso:
            x = float(juso[0]['entX'])  # ê²½ë„
            y = float(juso[0]['entY'])  # ìœ„ë„
            return pd.Series([y, x])
        else:
            return pd.Series([None, None])
    except Exception as e:
        print(f"â— ì˜¤ë¥˜ ë°œìƒ: {address} â†’ {e}")
        return pd.Series([None, None])

# âœ… ì§„í–‰ë¥  í‘œì‹œ
tqdm.pandas()

# ğŸ“‚ CSV ë¶ˆëŸ¬ì˜¤ê¸°
df = pd.read_csv('/content/ì•„íŒŒíŠ¸(ì „ì›”ì„¸)_ì‹¤ê±°ë˜ê°€.csv', encoding='cp949')

# âœ… ê²°ì¸¡ ì œê±° (ë„ë¡œëª…, ë³¸ë²ˆ, ë¶€ë²ˆ)
df = df[df['ë„ë¡œëª…'].notnull() & df['ë³¸ë²ˆ'].notnull() & df['ë¶€ë²ˆ'].notnull()]

# âœ… ë¬¸ìì—´ ì •ì œ
df['ì‹œêµ°êµ¬'] = df['ì‹œêµ°êµ¬'].astype(str).str.strip()
df['ë„ë¡œëª…'] = df['ë„ë¡œëª…'].astype(str).str.strip()
df['ë³¸ë²ˆ'] = df['ë³¸ë²ˆ'].astype(str).str.strip()
df['ë¶€ë²ˆ'] = df['ë¶€ë²ˆ'].astype(str).str.strip()

# âœ… ì „ì²´ì£¼ì†Œ ìƒì„± (ë„ë¡œëª…ì£¼ì†Œ: ì‹œêµ°êµ¬ + ë„ë¡œëª… + ë³¸ë²ˆ-ë¶€ë²ˆ)
df['ì „ì²´ì£¼ì†Œ'] = df['ì‹œêµ°êµ¬'] + ' ' + df['ë„ë¡œëª…'] + ' ' + df['ë³¸ë²ˆ'] + '-' + df['ë¶€ë²ˆ']

# âœ… ì¤‘ë³µ ì£¼ì†Œë§Œ ì¶”ì¶œí•´ì„œ ìœ„ê²½ë„ ì–»ê¸°
df_unique = df[['ì „ì²´ì£¼ì†Œ']].drop_duplicates().reset_index(drop=True)
df_unique[['ìœ„ë„', 'ê²½ë„']] = df_unique['ì „ì²´ì£¼ì†Œ'].progress_apply(get_coords_juso)

# âœ… ë³‘í•©
df = df.merge(df_unique, on='ì „ì²´ì£¼ì†Œ', how='left')

# âœ… ì €ì¥
df.to_csv('/content/ì•„íŒŒíŠ¸_ìœ„ê²½ë„_ì™„ì„±.csv', index=False)
print("ğŸ‰ ì²˜ë¦¬ ì™„ë£Œ! ìœ„ê²½ë„ í¬í•¨ëœ íŒŒì¼ ì €ì¥ ì™„ë£Œ")

# ìœ„ê²½ë„ ë¶™ì¸ í›„ ìµœì¢… dfë§Œ ë¶ˆëŸ¬ì™€ì„œ ë‹¤ì‹œ ì €ì¥
import pandas as pd

df = pd.read_csv('/content/ì•„íŒŒíŠ¸_ìœ„ê²½ë„_ì™„ì„±.csv', encoding='utf-8')  # ê¸°ì¡´ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
df.to_csv('/content/ì•„íŒŒíŠ¸_ìœ„ê²½ë„_ì™„ì„±_excelìš©.csv', index=False, encoding='cp949')  # ì—‘ì…€ í˜¸í™˜ìš©ìœ¼ë¡œ ì¬ì €ì¥

print("ğŸ“„ ì—‘ì…€ì—ì„œ ì˜ ì—´ë¦¬ëŠ” CSV ì €ì¥ ì™„ë£Œ!")

import os

# âœ… tqdm ì§„í–‰ë¥ 
tqdm.pandas()

# ğŸ“‚ CSV ë¶ˆëŸ¬ì˜¤ê¸°
df = pd.read_csv('/content/ì—°ë¦½ë‹¤ì„¸ëŒ€(ì „ì›”ì„¸)_ì‹¤ê±°ë˜ê°€.csv', encoding='cp949')

# âœ… ê²°ì¸¡ ì œê±°
df = df[df['ë„ë¡œëª…'].notnull() & df['ë³¸ë²ˆ'].notnull() & df['ë¶€ë²ˆ'].notnull()]

# âœ… ë¬¸ìì—´ ì •ì œ
df['ì‹œêµ°êµ¬'] = df['ì‹œêµ°êµ¬'].astype(str).str.strip()
df['ë„ë¡œëª…'] = df['ë„ë¡œëª…'].astype(str).str.strip()
df['ë³¸ë²ˆ'] = df['ë³¸ë²ˆ'].astype(str).str.strip()
df['ë¶€ë²ˆ'] = df['ë¶€ë²ˆ'].astype(str).str.strip()

# âœ… ì „ì²´ì£¼ì†Œ ìƒì„±
df['ì „ì²´ì£¼ì†Œ'] = df['ì‹œêµ°êµ¬'] + ' ' + df['ë„ë¡œëª…'] + ' ' + df['ë³¸ë²ˆ'] + '-' + df['ë¶€ë²ˆ']

# âœ… ìºì‹œ íŒŒì¼ ê²½ë¡œ
cache_path = '/content/address_cache.csv'

# âœ… ê¸°ì¡´ ìºì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
if os.path.exists(cache_path):
    cache_df = pd.read_csv(cache_path)
else:
    cache_df = pd.DataFrame(columns=['ì „ì²´ì£¼ì†Œ', 'ìœ„ë„', 'ê²½ë„'])

# âœ… ìƒˆë¡œ ìš”ì²­í•  ì£¼ì†Œë§Œ í•„í„°ë§
new_addresses = df[~df['ì „ì²´ì£¼ì†Œ'].isin(cache_df['ì „ì²´ì£¼ì†Œ'])][['ì „ì²´ì£¼ì†Œ']].drop_duplicates()
print(f"âœ¨ ìƒˆë¡œ ì¡°íšŒí•  ì£¼ì†Œ ìˆ˜: {len(new_addresses)}")

# âœ… ìœ„ê²½ë„ ê°€ì ¸ì˜¤ê¸°
new_addresses[['ìœ„ë„', 'ê²½ë„']] = new_addresses['ì „ì²´ì£¼ì†Œ'].progress_apply(get_coords_juso)

# âœ… ìºì‹œ ì—…ë°ì´íŠ¸
cache_df = pd.concat([cache_df, new_addresses], ignore_index=True).drop_duplicates(subset='ì „ì²´ì£¼ì†Œ')
cache_df.to_csv(cache_path, index=False)

# âœ… ë³‘í•©
df = df.merge(cache_df, on='ì „ì²´ì£¼ì†Œ', how='left')

# âœ… ì €ì¥
df.to_csv('/content/ì—°ë¦½ë‹¤ì„¸ëŒ€_ìœ„ê²½ë„_ì™„ì„±.csv', index=False, encoding='cp949')
print("âœ… ì—°ë¦½ë‹¤ì„¸ëŒ€ ì™„ë£Œ! ìœ„ê²½ë„ í¬í•¨ CSV ì €ì¥ë¨")