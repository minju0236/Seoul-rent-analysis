# -*- coding: utf-8 -*-
"""ì œë°œ ë˜ê²Œ í•´ì£¼ì„¸ìš” (0606).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OmpOfleI06bsXGzK4-LGkRTo1cUaGQ0F
"""

import pandas as pd
import folium
from folium.plugins import MarkerCluster
from tqdm import tqdm
import time

# 1. CSV ë¶ˆëŸ¬ì˜¤ê¸°
df_univ = pd.read_csv("ì„œìš¸ì‹œ_ëŒ€í•™_ì¢Œí‘œ.csv", encoding="cp949")
df_apt = pd.read_csv("ì•„íŒŒíŠ¸_ì¢Œí‘œ.csv", encoding="cp949")

# 2. ì§€ë„ ìƒì„±
m = folium.Map(location=[37.5665, 126.9780], zoom_start=11)

# 3. ëŒ€í•™ ë§ˆì»¤ (íŒŒë€ìƒ‰)
univ_cluster = MarkerCluster(name="ëŒ€í•™").add_to(m)
print("ğŸ“ ëŒ€í•™ ë§ˆì»¤ ì°ëŠ” ì¤‘...")
start_univ = time.time()

for _, row in tqdm(df_univ.iterrows(), total=len(df_univ), desc="ëŒ€í•™"):
    folium.Marker(
        location=[row["ìœ„ë„"], row["ê²½ë„"]],
        popup=row["í•™êµëª…"],
        icon=folium.Icon(color="blue", icon="university", prefix="fa")
    ).add_to(univ_cluster)

print(f"âœ… ëŒ€í•™ ë§ˆì»¤ ì™„ë£Œ! â±ï¸ {time.time() - start_univ:.2f}ì´ˆ")

# 4. ì•„íŒŒíŠ¸ ë§ˆì»¤ (ë¹¨ê°„ìƒ‰)
apt_cluster = MarkerCluster(name="ì•„íŒŒíŠ¸").add_to(m)
print("ğŸ  ì•„íŒŒíŠ¸ ë§ˆì»¤ ì°ëŠ” ì¤‘...")
start_apt = time.time()

for _, row in tqdm(df_apt.iterrows(), total=len(df_apt), desc="ì•„íŒŒíŠ¸"):
    folium.Marker(
        location=[row["ìœ„ë„"], row["ê²½ë„"]],
        popup=row["ì£¼ì†Œ"] if "ì£¼ì†Œ" in row else "ì•„íŒŒíŠ¸",
        icon=folium.Icon(color="red", icon="home", prefix="fa")
    ).add_to(apt_cluster)

print(f"âœ… ì•„íŒŒíŠ¸ ë§ˆì»¤ ì™„ë£Œ! â±ï¸ {time.time() - start_apt:.2f}ì´ˆ")

# 5. ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ì¶”ê°€
folium.LayerControl().add_to(m)

# 6. ì €ì¥
m.save("ëŒ€í•™_ì•„íŒŒíŠ¸_ì§€ë„.html")
print("ğŸ’¾ ì§€ë„ ì €ì¥ ì™„ë£Œ! ğŸ‰")

import pandas as pd
import requests
from tqdm import tqdm

# âœ… Kakao API í‚¤ ì…ë ¥
KAKAO_API_KEY = "KakaoAK 4a8ab5a61e4fafff2659520839bbb818"

# âœ… ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜
def get_coords_kakao(address):
    headers = {"Authorization": KAKAO_API_KEY}
    url = "https://dapi.kakao.com/v2/local/search/address.json"
    params = {"query": address}
    try:
        res = requests.get(url, headers=headers, params=params, timeout=3)
        docs = res.json().get("documents")
        if docs:
            return pd.Series([float(docs[0]["y"]), float(docs[0]["x"])])
    except:
        pass
    return pd.Series([None, None])

# âœ… CSV ë¶ˆëŸ¬ì˜¤ê¸°
df = pd.read_csv("ì„œìš¸êµí†µê³µì‚¬_ì—­ì£¼ì†Œ.csv", encoding="cp949")

# âœ… tqdmìœ¼ë¡œ ì§„í–‰ë¥  ë³´ê¸°
tqdm.pandas()

# âœ… ìœ„ë„/ê²½ë„ ë¶™ì´ê¸° (ì»¬ëŸ¼ëª…: ë„ë¡œëª…ì£¼ì†Œ)
df[['ìœ„ë„', 'ê²½ë„']] = df['ë„ë¡œëª…ì£¼ì†Œ'].progress_apply(get_coords_kakao)

# âœ… ì €ì¥
df.to_csv("ì„œìš¸êµí†µê³µì‚¬_ì—­ì£¼ì†Œ_ì¢Œí‘œí¬í•¨.csv", index=False, encoding="utf-8-sig")
print("ğŸ‰ ì €ì¥ ì™„ë£Œ: ì„œìš¸êµí†µê³µì‚¬_ì—­ì£¼ì†Œ_ì¢Œí‘œí¬í•¨.csv")

import pandas as pd
import requests
from tqdm import tqdm
import time

# âœ… Kakao Mobility API í‚¤ ì„¤ì •
KAKAO_REST_API_KEY = "KakaoAK 4a8ab5a61e4fafff2659520839bbb818"
headers = {"Authorization": KAKAO_REST_API_KEY}

# âœ… CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
df_apt = pd.read_csv("ì•„íŒŒíŠ¸_ì¢Œí‘œ.csv", encoding="cp949")
df_univ = pd.read_csv("ì„œìš¸ì‹œ_ëŒ€í•™_ì¢Œí‘œ.csv", encoding="cp949")
df_station = pd.read_csv("ì§€í•˜ì² ì—­_ì¢Œí‘œ.csv", encoding="utf-8")

# âœ… ë„ë³´ ì‹œê°„ ìš”ì²­ í•¨ìˆ˜ (ì´ˆ ë°˜í™˜)
def get_walk_time_kakao(start_lat, start_lng, end_lat, end_lng):
    url = "https://apis-navi.kakaomobility.com/v1/directions"
    params = {
        "origin": f"{start_lng},{start_lat}",
        "destination": f"{end_lng},{end_lat}",
        "priority": "TIME",
        "car_fuel": "GASOLINE",
        "car_hipass": False
    }
    try:
        res = requests.get(url, headers=headers, params=params, timeout=5)
        if res.status_code == 200:
            data = res.json()
            return data['routes'][0]['summary']['duration']  # ë‹¨ìœ„: ì´ˆ
    except:
        pass
    return None

# âœ… tqdm ì ìš©
tqdm.pandas()

# âœ… ê°€ì¥ ê°€ê¹Œìš´ ëŒ€í•™ ì°¾ê¸°
def get_closest_univ(row):
    min_time = float('inf')
    closest_name = None
    for _, u in df_univ.iterrows():
        t = get_walk_time_kakao(row['ìœ„ë„'], row['ê²½ë„'], u['ìœ„ë„'], u['ê²½ë„'])
        if t is not None and t < min_time:
            min_time = t
            closest_name = u['í•™êµëª…']
    return pd.Series([min_time if min_time != float('inf') else None, closest_name])

# âœ… ê°€ì¥ ê°€ê¹Œìš´ ì§€í•˜ì²  ì°¾ê¸°
def get_closest_station(row):
    min_time = float('inf')
    closest_name = None
    for _, s in df_station.iterrows():
        t = get_walk_time_kakao(row['ìœ„ë„'], row['ê²½ë„'], s['ìœ„ë„'], s['ê²½ë„'])
        if t is not None and t < min_time:
            min_time = t
            closest_name = s['ì—­ëª…']
    return pd.Series([min_time if min_time != float('inf') else None, closest_name])

# âœ… ì‹œê°„ ì¸¡ì • ì‹œì‘
start = time.time()

# âœ… ë„ë³´ ì‹œê°„ ê³„ì‚° ìˆ˜í–‰
df_apt[["ëŒ€í•™_ë„ë³´ì‹œê°„(ì´ˆ)", "ê°€ê¹Œìš´_ëŒ€í•™ëª…"]] = df_apt.progress_apply(get_closest_univ, axis=1)
df_apt[["ì§€í•˜ì² _ë„ë³´ì‹œê°„(ì´ˆ)", "ê°€ê¹Œìš´_ì§€í•˜ì² ì—­ëª…"]] = df_apt.progress_apply(get_closest_station, axis=1)

# âœ… ì´ˆ â†’ ë¶„ ë³€í™˜
df_apt["ëŒ€í•™_ë„ë³´ì‹œê°„(ë¶„)"] = (df_apt["ëŒ€í•™_ë„ë³´ì‹œê°„(ì´ˆ)"] // 60).astype("Int64")
df_apt["ì§€í•˜ì² _ë„ë³´ì‹œê°„(ë¶„)"] = (df_apt["ì§€í•˜ì² _ë„ë³´ì‹œê°„(ì´ˆ)"] // 60).astype("Int64")

print(f"ğŸ”„ ì „ì²´ ì‹œê°„: {time.time() - start:.2f}ì´ˆ")

# âœ… ì¡°ê±´ í•„í„°ë§: ëŒ€í•™ 15ë¶„ ì´ë‚´ & ì§€í•˜ì²  10ë¶„ ì´ë‚´
df_filtered = df_apt[
    (df_apt["ëŒ€í•™_ë„ë³´ì‹œê°„(ì´ˆ)"] <= 900) &  # 15ë¶„
    (df_apt["ì§€í•˜ì² _ë„ë³´ì‹œê°„(ì´ˆ)"] <= 600)  # 10ë¶„
]

# âœ… ê²°ê³¼ ì €ì¥
df_filtered.to_csv("ì¹´ì¹´ì˜¤_ë„ë³´ì¡°ê±´_ëŒ€í•™ì—­ì„¸ê¶Œ_ì•„íŒŒíŠ¸.csv", index=False, encoding="cp949")
print("âœ… ì €ì¥ ì™„ë£Œ: ì¹´ì¹´ì˜¤_ë„ë³´ì¡°ê±´_ëŒ€í•™ì—­ì„¸ê¶Œ_ì•„íŒŒíŠ¸.csv")

import requests

# âœ… Kakao Mobilityì—ì„œ ë°œê¸‰ë°›ì€ REST API í‚¤ (ì£¼ì˜: "KakaoAK " í¬í•¨)
KAKAO_REST_API_KEY = "KakaoAK 4a8ab5a61e4fafff2659520839bbb818"

# âœ… ìš”ì²­ í—¤ë”
headers = {
    "Authorization": KAKAO_REST_API_KEY
}

# âœ… ì¶œë°œì§€(origin)ì™€ ë„ì°©ì§€(destination)
params = {
    "origin": "126.970833,37.554722",       # ì„œìš¸ì—­ (lng, lat)
    "destination": "126.9779451,37.5662952",  # ì‹œì²­ì—­ (lng, lat)
    "priority": "TIME",  # ì‹œê°„ ê¸°ì¤€ ë„ë³´ ê²½ë¡œ
    "car_fuel": "GASOLINE",  # ë„ë³´ì—ë„ í•„ìš” ì—†ì§€ë§Œ í•„ìˆ˜ í•„ë“œì¸ ê²½ìš° ëŒ€ë¹„
    "car_hipass": False      # ë„ë³´ì—ë„ í•„ìš” ì—†ì§€ë§Œ í•„ìˆ˜ í•„ë“œì¸ ê²½ìš° ëŒ€ë¹„
}

# âœ… ë„ë³´ ìš”ì²­ URL
url = "https://apis-navi.kakaomobility.com/v1/directions"

# âœ… GET ìš”ì²­ ë³´ë‚´ê¸°
res = requests.get(url, headers=headers, params=params)

# âœ… ì‘ë‹µ í™•ì¸
print(f"ğŸ“¡ ìƒíƒœì½”ë“œ: {res.status_code}")
try:
    data = res.json()
    if 'routes' in data:
        summary = data['routes'][0]['summary']
        print(f"ğŸš¶ ë„ë³´ ê±°ë¦¬: {summary['distance']}m")
        print(f"â±ï¸ ì˜ˆìƒ ì‹œê°„: {summary['duration']//60}ë¶„")
    else:
        print("âŒ ê²½ë¡œ ì—†ìŒ:", data)
except Exception as e:
    print("âŒ ì˜¤ë¥˜:", e)

print("ğŸ” ìš”ì²­ í—¤ë”:")
for k, v in headers.items():
    print(f"{k}: {v}")